## 审批系统当前规则与功能（截至最新改动）

### 1. 状态与动作
- 状态：`DRAFT`（退回/撤回后的临时态）、`IN_PROGRESS`、`APPROVED`、`REJECTED`、`WITHDRAWN`（已撤回）。旧状态 `PENDING` 已废弃。
- 提交（SUBMIT）：进入 `IN_PROGRESS`；若提交人角色=首节点角色，则自动同意首节点并流转下一节点。
- 审批（APPROVE/REJECT/RETURN）：仅当前节点角色可执行；`RETURN/WITHDRAW` 都会回到 `DRAFT`。
- 删除草稿：`POST /workflows/:id/delete`，仅提交人可删除 `DRAFT`。

### 2. 节点链路（默认）
- 新增目标医院：DSM → RSM → BISO1 → BISO2 → C&D → RSD。
- 取消目标医院：DSM → RSM → BISO1 → BISO2 → RSD。
- 新增关联药房：
  - 白名单/非其他：DSM → RSM → BISO1 → BISO2 → RSD。
  - 其他 + 关联：DSM → RSM → C&D → BISO1 → BISO2 → RSD。
  - 其他 + A类：DSM → RSM → BISO1 → BISO2 → RSD（无 C&D）。
- 取消关联药房：DSM → RSM → BISO1 → BISO2 → RSD。
- 医院区域调整：DSM → RSM → BISO1 → RSD → BISO2（仅 DSM/RSM 可发起）。
- 流程预览包含提交人节点；DSM/RSM 发起时从对应节点开始。

### 3. 表单与校验
- 新增目标医院：机构名称/地址、指派代表姓名+岗位号、附件（必填）、新增理由（必填）。
- 取消目标医院：机构名称+编码、取消原因、分配明细（总和=100%，每行百分比 1-100），附件改为非必填。
- 新增关联药房：
  - 先选“关联医院”（指标表权限范围），展示该医院已关联药店（指标表）。
  - 已关联>=3 家时禁止新增。
  - 再选药店（白名单减去指标表已关联；允许“其他”）。
  - 药店类型 A类/关联，提交人可修改。
- 取消关联药房：从指标表已关联药店中选择，自动带出关联医院/编码；附件改为非必填。
- 医院区域调整：机构名称/编码、调整前代表与岗位号（自动带出）、调整后代表与岗位号（可选，不能与调整前相同）、调整原因必填。

### 4. 附件规则
- 新增目标医院：提交前必须有附件（文件名+URL+MIME）。
- 新增关联药房：
  - 其他 + A类：提交前必填附件。
  - 其他 + 关联：C&D 节点同意前必须存在附件（可多条）。
  - 非“其他”：无附件要求。
- 取消目标医院 / 取消关联药房：附件可选。
- 附件仅记录元信息，无需真实上传。

### 5. 数据来源与范围
- 医院权限：`HospitalAssignment`。
- 药店白名单：`WhitelistRecord` + `PharmacyHospitalLink`。
- 指标表已关联：`PharmacyHospitalAssignment`（同一药店仅能关联一个医院）。
- 新增关联药房候选 = 白名单 ∩ 权限医院，剔除指标表已关联药店；`#N/A` 为占位编码，会影响去重逻辑。
- 取消关联药房候选 = 权限医院在指标表中已关联的药店。

### 6. 导入/导出
- 导入脚本：`import:assignments`、`import:pharmacy-whitelist`、`import:users`。
- 导出：`GET /workflows/export?format=xlsx&multiSheet=true` 导出 5 个 Sheet。
- 归档查看仅 BISO1/BISO2 可见，导出按钮随归档模块显示。

### 7. 登录与身份
- 前端从 localStorage `tokenInfo` 读取 SaaS token。
- `GET /auth/saas-user` 代理 SaaS 用户信息，`POST /auth/resolve-user` 根据 email 映射岗位号/角色/大区。
- `authEmail` 保存在本地用于展示/切换。
- `/auth/mock-login` 保留用于本地联调（非默认入口）。

### 8. 前端模块
- H5：MR 仅“发起申请/已提交”；DSM/RSM 增加“我审批的”；BISO1/BISO2/RSD/CD 仅“我审批的”。详情与卡片样式与旧版一致，审批流程时间轴随步骤展示。
- PC：菜单随角色同 H5；BISO1/BISO2 额外显示“节点负责人配置/归档查看”。发起页选择流程后才展示对应表单。
- 归档查看：支持状态筛选、提交/审批时间筛选、全文搜索、显示提交人大区。
