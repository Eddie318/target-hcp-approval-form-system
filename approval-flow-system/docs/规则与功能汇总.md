## 审批系统当前规则与功能（截至最新改动）

### 1. 流程状态与动作
- 状态：`DRAFT`（草稿/撤回/退回）、`IN_PROGRESS`（办理中）、`APPROVED`（通过）、`REJECTED`（驳回）。`PENDING/WITHDRAWN` 已移除。
- 提交（SUBMIT）：流程直接进入 `IN_PROGRESS`；若提交人角色=首节点角色，则自动同意首节点并流转下一节点。
- 审批（APPROVE/REJECT/RETURN）：仅当前步骤角色可执行。
- 退回（RETURN）：重置流程为 `DRAFT`，所有步骤状态重置为 `DRAFT`，由发起人修改后再提交。
- 撤回（WITHDRAW）：与退回同效，流程回 `DRAFT`，仅发起人可见。
- 删除草稿：仅发起人且状态 `DRAFT` 时可调用 `POST /workflows/:id/delete` 删除流程（前端动作区已增加“删除草稿”选项）。
- 新增目标医院提交前：必须已有凭证附件；前端要求填写文件名和 URL（草稿可不填），提交时后端也会校验至少有一条附件。

### 2. 节点与流转（默认链路）
- 默认节点链：MR → DSM → RSM → BISO1 → BISO2 → RSD →（可选 C&D 分支）。
- 提交后的下一审批人：
  - MR 提交：首节点 DSM 办理。
  - DSM 提交：首节点 RSM 办理。
  - RSM 提交：首节点 BISO1 办理。
- 提交人即首节点时的自动流转：自动同意首节点；若下一节点是 RSM，会依据 `UserHierarchy`（首节点 assignee 的直属上级）自动写入 RSM assignee。
- C&D 分支：
  - 新增目标医院：固定链路包含 C&D，顺序为 DSM → RSM → BISO1 → BISO2 → C&D → RSD。
  - 新增关联药房：仅在药店来源“其他”且 A 类药房时插入 C&D（RSM 之后）。

### 3. 权限与可见性
- 仅提交人可提交/撤回/删除草稿。
- 可见范围：
  - `DRAFT`：仅提交人可见。
  - `IN_PROGRESS`：提交人、当前步骤 assignee 可见。
  - 终态（APPROVED/REJECTED）：提交人及曾经的节点办理人可查（列表按 assignee 过滤）。
- 角色权限矩阵（简述）：MR/DSM/RSM 可发起；审批动作按节点角色匹配；BISO1/BISO2 才能导出。
- 代表选择范围：DSM 看到其下 MR；RSM 看到其下所有 DSM 的 MR；MR 只能选自己。

### 4. 数据与校验
- 主数据/权限：使用导入的医院/药店/代表/层级（MR→DSM→RSM）权限做范围校验。
- 取消目标医院分配：分配百分比必须为正数，且合计 100%，分配医院需在提交人权限范围内。
- 白名单与指标弱校验：当前占位，不强校验；白名单变动需后续对接文件导入。
- 附件要求：C&D 审批 APPROVE 前需至少有一条附件记录；其他附件仅记录元信息（文件名/URL/MIME）。

### 5. 导入/导出与日志
- 导入脚本：`import:assignments`（医院关联/权限）、`import:pharmacy-whitelist`、`import:users`（UserMapping + UserHierarchy）。
- 审计日志：操作写入 OperationLog；导入日志 ImportLog 可查（已实现 API）。
- 导出：`GET /workflows/export`，仅 BISO1/BISO2，可选 CSV/XLSX，全字段输出。

### 6. 短链与鉴权
- Mock 登录：`/auth/mock-login?email=...` 返回 actorCode/actorRole，前端注入请求头。
- 短链占位：签名、有效期、防重放（tokenHash 记入 OperationLog），支持直接调用审批动作。
- 企业微信/OAuth：待接入，需企业邮箱 → 岗位号映射（`UserMapping` 与 `UserHierarchy`）。

### 7. 前端（PC/H5 状态）
- PC 端：支持模拟登录、流程列表占位、动作（提交/审批）、附件记录；新增目标医院表单（指派代表下拉、自动填岗位号、上传元信息）；其他流程用 JSON 占位表单；支持提交。
- 移动端 H5（web-mobile，最新）：底部 Tab 仅保留“发起申请 / 已提交”；无草稿概念。新增目标医院表单字段同 PC（机构名称/地址、代表姓名/岗位号、附件文件名+URL+MIME、原因≥10 字），提交按钮固定在底部；顶部导航固定显示当前流程名。审批流程展示简化为角色+姓名（无头像、无“待审批”标识）。表单/审批区域全宽铺满（去卡片样式），进入表单时底部 Tab 隐藏。已提交列表支持搜索（机构/人员）、筛选状态/类型/时间，并展示当前节点审批人或驳回原因；暂不提供驳回后的重新编辑。审批角色（BISO1/BISO2/RSD/C&D）登录仅显示审批模块，隐藏创建/附件模块；列表自动刷新。

### 8. 当前风险与待办
- 旧数据的状态迁移：若库中有 `PENDING/WITHDRAWN` 需批量改成 `IN_PROGRESS`/`DRAFT`；旧测试流程已清理（含缺失 assignee 的老记录）。
- 权限对接真实登录：需企业微信身份映射到岗位号；Mock 可继续用于联调。
- 表单完整度：除“新增目标医院”外，其它流程仍是 JSON 占位，需要补齐字段、校验与权限过滤。
- 前端删除草稿：需补按钮调用 `POST /workflows/:id/delete`（头部带 x-actor-code）。
- 列表/搜索筛选（待实现接口）：希望 `/workflows` 支持状态 + 时间区间（近7/30/90、自定义）+ 搜索机构名称或人员姓名。当前仅支持 type/status/actorCode，需要后端扩展。
- 搜索字段：新增目标医院可按机构名称、人员姓名搜索；机构编码暂不需要。
- 附件回填：后端仅存附件元信息（文件名/URL/MIME）；编辑时直接回填这些字段，无需重新上传。后端需提供查询附件元信息的接口或在 GET /workflows 中返回 files。

### 9. 管理后台（配置与归档）
- 节点负责人配置（PC 管理页签）：可配置 BISO1、BISO2、RSD、C&D（姓名、邮箱、岗位号、启用），每角色只显示一条，作用于所有流程类型。岗位号必填，用于将后续节点 assignee 写入。
- 自动分配：当流程流转到 BISO1/BISO2/RSD/C&D 节点时，系统会读取对应流程类型的 ApproverConfig，将 actorCode 写入步骤 assignee（无岗位号则留空，审批人将无法看到/办理）。
- 归档展示（PC 管理页签）：按流程类型 + 状态(APPROVED/REJECTED)查看。新增目标医院展示：流程ID、发起人(代码)、机构名称/地址、指派代表姓名/岗位号、BISO1/BISO2/RSD/C&D 负责人姓名/邮箱（来自配置）。其他流程暂用 JSON 占位。
- 前端可见性：BISO1/BISO2/RSD/C&D 登录仅显示审批相关模块（无创建/附件等）。

### 10. 前端（PC/H5）近期更新
- PC 左侧页签：流程操作、节点负责人配置、归档查看。
- 审批角色（BISO1/BISO2/RSD/C&D）登录仅显示审批模块，隐藏创建/附件模块。
- 节点负责人列表去重：BISO1/BISO2/RSD 各一条，C&D 一条；配置表单要求邮箱+岗位号。
- 登录/提交/审批/删除后自动刷新流程列表，已移除手动“拉取列表”按钮。
