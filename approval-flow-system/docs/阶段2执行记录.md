# 阶段 2 执行记录（当前可先做的部分）

## 本轮已落地
- 新增 API 模块骨架：`WorkflowModule`，含控制器/服务占位；创建与查询接口返回占位数据。
- 定义基础枚举：流程类型、状态、动作、角色（BISO1/BISO2/RSD/C&D 等），文件 `apps/api/src/modules/workflow/workflow.constants.ts`。
- 状态机与权限占位：`workflow.state.ts`（合法迁移）、`workflow.permission.ts`（角色-动作矩阵），动作接口 `POST /workflows/:id/actions` 返回占位结果。
- DTO 占位：`CreateWorkflowDto`、`ActionWorkflowDto`（后续按类型收紧）。
- 测试：常量单测 `workflow.constants.spec.ts`、状态机单测 `workflow.state.spec.ts`；现有 lint/test/build 均通过。
- 文档：`docs/阶段2任务清单.md`（任务全量），`docs/阶段1验收报告.md`（归档），`docs/阶段2验收报告.md`。
- 数据导入脚本：`scripts/import-assignments.js`（全量覆盖导入医院/药店 + 医院-MR 占比关系，校验占比=100%），根脚本 `npm run import:assignments -- --file=testdata.csv`。
- 数据导入（当前策略）：占比异常仅提示不拦截，已导入 `testdata.csv` 到本地 Postgres（compose db）。如需强校验可恢复拦截。

## 待补充（依赖确认/数据）
- 销售团队主数据/权限落库：代表（MR/DSM/RSM）、区域、上下级、代表-医院/药店权限。
- 药店白名单导入：文件格式/字段、覆盖规则、生效与自动驳回逻辑落地。
- 指标弱校验数据源：额度字段名/单位、获取方式（API/文件）、频率；弱校验逻辑接入。
- 流程与表单持久化：Prisma 表结构、迁移、真实创建/查询/审批动作。
- 审批状态机/节点编排实现：二审空窗、C&D 分支、撤回/退回/驳回、权限校验。
- 邮件内审批（企业微信 OAuth 短链）：签名、回调、意见必填校验。
- 导出/筛选：真实字段、权限过滤、模板下载接入。

## 当前功能说明（占位）
- POST /workflows：接受 type/payload/title，返回占位流程对象（status=DRAFT，id 临时）。
- GET /workflows/:id：返回占位对象（status=DRAFT）。
- 仅用于后续开发占位，不具备真实业务能力。

## 测试操作指南（当前）
- 根目录：
  - `npm run lint`
  - `npm run test`（包含 workflow 常量单测）
  - `npm run build`
- Mock/API 骨架：
  - API：`cd apps/api && npm run start:dev`，访问 `/health`、`/api-docs`（Swagger 仍为空），`POST /workflows` 返回占位数据。
  - Mock：`cd apps/mock && npm run start:dev`，访问 `http://localhost:4001/masterdata/hospitals` 等。
- Docker 构建：`docker compose build`（已通过）；如需运行：`docker compose up --build`。
- 合同测试（mock）：`npm run contract-test`（需 mock 运行）。
- 导入脚本：`npm run import:assignments -- --file=your.csv`（需先有数据库连接，默认使用 .env 中 DATABASE_URL；当前未执行迁移，需待数据库可用后 `npx prisma migrate dev`）。
- 导入注意：如用本地 compose，命令建议 `DATABASE_URL=postgres://approval_user:example_password@localhost:5432/approval_db npm run import:assignments -- --file=...`。
