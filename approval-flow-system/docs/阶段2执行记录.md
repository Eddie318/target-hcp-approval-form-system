# 阶段 2 执行记录（最新版）

## 本轮已落地
- **持久化工作流**：Prisma schema 覆盖工作流/节点/动作/附件/主数据表，API 读写 Postgres。
- **核心接口可用**：`POST /workflows`、`GET /workflows`、`GET /workflows/:id`、`POST /workflows/:id/actions`、`POST /workflows/:id/attachments`。
- **节点链路**：默认链路 MR → DSM → RSM → BISO1 → BISO2 → RSD；“新增关联药房”当药店=其他且类型=A 类时，RSM 后动态插入 C&D 节点；C&D 审批前必须有附件。
- **状态机与动作**：SUBMIT/APPROVE/REJECT/RETURN/WITHDRAW 落地，节点状态同步，二审空窗按默认链路执行。
- **校验**：取消目标医院分配必填、百分比>0，支持 percent/sharePercent，合计=100%；草稿仅提交人可见；C&D 审批无附件不可通过。
- **权限范围（已落地部分）**：提交时如 payload 含 hospitalCode 校验提交人权限；取消目标医院创建/审批都校验分配医院在提交人/审批人范围；审批动作必须匹配当前步骤角色。
- **数据导入**：`scripts/import-assignments.js` 支持命令行全量覆盖导入医院/药店/分配表（当前 CSV 无占比列，sharePercent 默认 0）。已用 compose DB 导入示例数据。
- **Swagger**：Create/Action/List/Attachment DTO 均展示 schema，便于在 `/api-docs` 直接测试。
- **工程化**：lint/test/build 全绿；校验单测新增了 percent/sharePercent 场景。
- **鉴权占位**：控制器支持从请求头 `x-actor-code` / `x-actor-role` 自动回填提交人/审批人，减少手工填写。
- **导出占位**：新增 `GET /workflows/export`，仅 BISO1/BISO2 可用，支持 CSV/XLSX，含步骤/动作/附件；可按 type/status/时间范围过滤（无脱敏）。
- **审计占位**：引入 WorkflowAuditService，记录创建/审批/导出等关键操作（当前复用 workflowAction 记录，后续可独立表）。
- **导入日志**：新增 ImportLog 表，assignments / 白名单导入脚本都会记录批次、文件名、数量、结果与消息。
- **短链占位**：提供短链签名服务和执行接口 `POST /workflows/shortlink/actions`，校验签名与过期后直达审批动作（待接入企业微信身份后补全）。
- **节点审批人配置**：新增 ApproverConfig 表与 CRUD 接口（按流程类型+角色配置企业邮箱/岗位号），便于配置不在主数据里的审批人。
- **用户映射**：新增 UserMapping 表与导入脚本（人员.csv → 邮箱/岗位号/角色），空邮箱自动禁用；`GET /auth/mock-login` 可用于模拟登录获取 actorCode/actorRole。

## 待办 / 待确认
- **鉴权上下文**：actorCode/role 仍由请求体传入，未与登录态/Token 绑定；其他流程的提交/审批/导出权限过滤待接统一鉴权。
- **主数据与白名单**：真实白名单导入、机构主数据对接（文件/API）、字段/覆盖策略、自动驳回规则仍为占位。
- **指标弱校验**：额度数据源、字段定义、校验规则未接入（当前仅表结构占位）。
- **邮件内审批**：企业微信 OAuth 短链、签名与有效期校验未实现。
- **导出/筛选**：列表仅支持 type/status/actorCode 简单过滤，未实现全字段导出、权限过滤、模板下载。
- **区域调整**：岗位强制匹配、跨区限制逻辑未编码（需求已记录）。

## 当前接口与用法
- `POST /workflows`：创建流程，必填 `type`，可选 `title`、`payload`、`submittedBy`。取消目标医院时 payload.distributions 合计 100（percent/sharePercent 任一）。
- `GET /workflows`：按 `type/status/actorCode` 过滤；actorCode 查看草稿仅限本人。
- `GET /workflows/:id`：草稿仅提交人可见。
- `POST /workflows/:id/actions`：校验状态机、权限矩阵、当前步骤角色；取消目标医院校验审批人医院范围；C&D 审批需先上传附件。
- `POST /workflows/:id/attachments`：记录附件元信息（用于 C&D 审批）。
- `GET /workflows/export`：仅 BISO1/BISO2，默认导出 CSV；`?format=json` 返回 JSON；含步骤/动作/附件；当前无筛选/脱敏。
- `POST /workflows/shortlink/actions`：携带短链 token 执行审批动作（签名+过期校验，暂不包含用户身份）。
- `GET/POST/PUT/DELETE /approver-configs`：按流程类型+角色维护审批人（企业邮箱、岗位号、启用状态）。

## 测试操作指南
- 根目录：`npm run lint && npm run test && npm run build`。
- 启动：`docker compose up --build` 或 `cd apps/api && npm run start:dev`；验证 `/health`、`/api-docs`。
- 导入示例：`npm run import:assignments -- --file=your.csv`（当前 CSV 无占比列，sharePercent 将写 0）。
- 取消医院示例：payload.distributions 填 percent 或 sharePercent，合计 100。
- 新增关联药房示例：当药店=其他且类型=A 类，在 RSM 后自动出现 C&D 节点；先 `POST /workflows/:id/attachments` 再让 C&D APPROVE。

## 记录
- 最新验证：`npm run lint && npm run test` 均通过；Docker 仍可一键启动。
- 已知待办：见“待办 / 待确认”，需要业务侧确认后继续实现。
