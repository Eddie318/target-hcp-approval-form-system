# 开发计划（审批流系统）

## 前置确认
- 需求基线：基于 `需求文档框架.md`，采用弱校验（指标分配不锁额度），邮件内审批仅支持企业微信 OAuth 免登短链。
- 角色/流程：MR、DSM、RSM、BISO 1、BISO 2、RSD、C&D；五类流程及分支（含 C&D 分支、二审批人空窗）。
- 附件：jpg/png，长期保留；自动编码暂自由填，后续可加规则。

## 分阶段实施与标准、测试
### 阶段 1 环境与基础设施
- 工作：仓库与分支策略；CI（lint/test/build）；.env 模板与密钥管理；三方接口契约（主数据/指标/通知）及 mock。
- 达标：CI 全绿；本地一键启动（含 mock）；接口契约文档定稿。
- 测试：PR 流水线跑 lint+unit+build；契约/集成测试校验 mock 的请求/响应字段与错误码。

### 阶段 2 数据模型与权限
- 工作：模型设计（流程、节点、五类表单、附件、白名单映射、角色、区域、提交人管理链路）；权限校验（角色/区域/下属/白名单可见性）；跨区仅限下属；二审批人空窗逻辑。
- 达标：模型迁移成功；所有入口做权限校验；二审批人空窗生效。
- 测试：单元测试权限判定、跨区限制、白名单过滤；越权访问返回拒绝；二审为空→流转二审，非空→不流转。

### 阶段 3 表单与草稿
- 工作：五类表单字段/校验；草稿保存/续填；附件上传（jpg/png）；取消目标医院前端 100% 分配校验；主数据/白名单兜底搜索+自由填；编码自由填。
- 达标：必填/格式校验到位；草稿 CRUD 可用；附件格式限制生效；分配 99%/101% 阻断。
- 测试：表单校验用例（缺字段、格式错、分配非 100%）；草稿保存/加载/更新/删除；附件上传非 jpg/png 被拒；白名单有/无、主数据查不到→自由填通过。

### 阶段 4 审批流引擎
- 工作：审批链编排（新角色顺序、二审空窗）；C&D 分支（非白名单且类型=关联，RSM 后插 C&D，需上传凭证后继续）；动作：通过/驳回/退回到申请人/撤回（申请人、BISO1、BISO2，可配置）；弱校验分配（不锁额度）。
- 达标：五类流程+分支可跑通；历史记录完整；弱校验符合预期。
- 测试：全流程 happy path；C&D 触发/不触发；二审空窗场景；驳回后重提、退回后重提、撤回权限校验；并发弱校验模拟（两人分配同额度，系统仅校验权限+100%，不锁额度）。

### 阶段 5 通知与邮件内审批
- 工作：邮件/IM 通知；企业微信 OAuth 短链免登；邮件内通过/驳回（驳回需意见）；抄送策略。
- 达标：通知触达；短链授权后可审批；短链有效期/单次使用策略生效。
- 测试：OAuth 回调/token 校验；短链过期/篡改/重复提交被拒；邮件内通过、驳回（含意见）；通知在发起/通过/驳回/撤回发送，抄送正确。

### 阶段 6 归档、查询、导出
- 工作：归档查询（移动+PC）；PC 批量导出 CSV/XLSX 全字段；列头模板下载；筛选（流程、状态、角色/节点、时间、区域、机构/药店名、跨区标记、C&D 分支标记）。
- 达标：查询响应正常；导出字段完整且无乱码；筛选准确；模板可用。
- 测试：导出字段核对；CSV/XLSX 打开检查；筛选单/多条件联筛正确；模板下载可用且列头匹配导出；归档可见性符合权限。

### 阶段 7 集成与上线前检查
- 工作：对接主数据/指标接口（读取+弱校验复核）；通知网关；性能/并发、异常/降级；部署脚本与监控告警。
- 达标：集成连通性稳定；性能达标（自定义 P95 等）；异常有降级/重试；监控/告警就绪。
- 测试：集成调用（主数据查询、指标弱校验、通知发送）；第三方失败时兜底提示；并发压测（提交+审批+附件）；权限/短链有效期安全测试。

## 全局测试覆盖
- 单元：权限、校验规则、分支决策、二审空窗、弱校验算法。
- 集成：主数据/指标/通知接口契约，OAuth 流程。
- 端到端：五类流程全链路（含分支、撤回/驳回/退回）。
- 并发/性能：分配并发、审批并发、附件上传。
- 安全：越权、短链有效期/单次使用校验、输入校验。
- 回归：每阶段完成后全量自动化（CI）+关键手工验证（邮件内审批、导出字段核对）。
