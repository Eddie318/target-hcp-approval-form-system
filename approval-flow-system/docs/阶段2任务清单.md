# 阶段 2 任务清单（审批流业务逻辑）

## 一、数据准备与对接
- 销售团队主数据接入：获取代表/区域/岗位/上下级/代表-医院-权限；定时全量+增量同步，落库映射；按提交人查询“我能管理的代表/医院列表”。越权访问拒绝，数据含更新时间。
- 药店白名单：客户每半年 Excel 上传/同步；字段校验后入库（whitelist 表），生效策略：最新覆盖，流程中若变动自动驳回提示，已归档不受影响。
- 主数据兜底：医院/药店接口查询，对不上时可自由填写（标记 source=manual）。

## 二、数据模型（Prisma）
- 建议表：users/roles/regions/permissions；hospitals/pharmacies（含 source）；whitelist_pharmacies；workflows；workflow_steps；approvals；forms_* 或 forms+jsonb；attachments；metrics_cache。
- 要求：迁移成功，索引/外键支持查询；字段覆盖表单/审批需求。

## 三、审批链与状态机
- 节点编排：五类流程，顺序含 BISO1/BISO2/C&D/RSD；二审空窗（只有一审为空时走二审）；C&D 分支（非白名单且类型=关联 → RSM 后插 C&D，需上传凭证）。
- 状态机：草稿、待审批、审批中、已驳回、已撤回、已通过/归档。
- 动作：通过、驳回、退回到申请人、撤回（申请人+BISO1+BISO2，可配置）。

## 四、表单与校验
- 取消目标医院：分配合计 100%，弱校验（不锁额度），医院范围=提交人权限内。
- 区域调整：岗位强制匹配（代表→代表/同级），可跨区但限提交人下属。
- 新增关联药房：白名单优先；非白名单→主数据→自由填；A 类凭证必填；触发 C&D 分支需 C&D 上传凭证。
- 附件：必填场景（A 类、搬迁/闭店/装修、新增医院凭证），格式 jpg/png。

## 五、权限与可见性
- 发起：MR/DSM/RSM（区域调整仅 DSM/RSM）。
- 审批：按节点角色，二审空窗；C&D 节点附件上传权限。
- 查看/导出：按区域/角色过滤；无权限数据不可见。

## 六、集成接口
- 主数据：医院/药店查询，代表/区域拉取；失败兜底提示。
- 指标（弱校验）：获取权限内机构+可分配额度；提交时复核 100%+权限，不锁额度，额度不足提示但不拒绝。
- 通知：调用 /notify/approval（processId/status/actionBy/comment）。

## 七、邮件内审批（企业微信 OAuth 短链）
- 短链签名、OAuth 跳转、回调执行通过/驳回（驳回必填意见）；短链有效期/单次使用校验。

## 八、归档/查询/导出
- 列表/详情；导出 CSV/XLSX 全字段；列头模板下载；筛选：流程、状态、角色/节点、时间、区域、机构/药店、跨区标记、C&D 分支标记。

## 九、同步与数据流
- 销售数据：API/文件同步（每日全量+增量），更新权限表；缺字段/重复 ID 处理；数据有效期。
- 白名单：上传校验、导入日志、生效覆盖；变动自动驳回提示。
- 指标：定时同步 metrics_cache；提交弱校验；失败提示不阻断。
- 审计：同步日志、重试/补偿策略。

## 十、测试计划
- 单元：权限判定、校验规则（100% 分配、附件必填、岗位匹配、二审空窗）、C&D 分支决策。
- 集成：主数据/指标/通知接口（mock/真实）、OAuth 短链。
- 端到端：五流程全链路（含分支、撤回/退回/驳回）；弱校验并发模拟。
- 并发/性能：提交/审批/附件并发；弱校验并发占用场景。
- 安全：越权访问、短链有效期/单次使用、输入校验。
- 回归：CI 扩充新增自动化（unit/integration/e2e）。

## 十一、交付物
- 更新 Prisma schema+migrations。
- 流程/审批/表单/权限/通知/指标弱校验代码。
- 配置化审批链（节点/二审/C&D 分支）。
- 邮件内审批短链实现。
- 导出/筛选与模板文件。
- 自动化测试与 CI 配置更新。
- 运维文档：数据同步、故障/降级、接口对接说明。
