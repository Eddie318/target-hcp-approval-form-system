# 阶段 2 剩余任务 · 可执行清单

> 说明：标注“依赖确认”的需业务/数据同事提供字段或接口；未标注的可直接开发。

## 任务 1：Prisma 数据库建模与迁移（部分依赖确认）
- 文件：`prisma/schema.prisma`、`prisma/migrations/*`、实体定义（`apps/api/src/modules/workflow/entities/*` 可选）。
- 内容：建表（建议）`workflows`、`workflow_steps`、`workflow_actions`、`workflow_payloads`（或 forms JSON）、`workflow_relations`（权限）、`attachments`、`whitelist_records`、`target_metrics`、`users/roles/regions/permissions`、`hospitals/pharmacies`。
- 完成标准：`npx prisma generate`、`npx prisma migrate dev` 成功；表字段覆盖流程、节点、审批记录、附件、白名单、额度等需求。
- 依赖：主数据字段、白名单字段、额度字段确认。

## 任务 2：审批状态机实现
- 文件：`apps/api/src/modules/workflow/workflow.state.ts`、`workflow.transition.ts`。
- 内容：定义合法状态/动作转换（草稿→待审批→审批中→通过/驳回/撤回等）；校验动作合法性；提供接口 `POST /workflows/:id/actions` 更新状态。
- 完成标准：单测覆盖各状态合法动作；非法动作被拒。

## 任务 3：权限矩阵
- 文件：`workflow.permission.ts`。
- 内容：按流程类型与角色（MR/DSM/RSM/BISO1/BISO2/RSD/C&D）定义可执行动作；返回当前用户的可用动作接口。
- 完成标准：单测验证各角色/流程的权限；越权动作被拒。
- 依赖：角色-用户-机构的权限数据。

## 任务 4：审批链节点落地
- 文件：`steps/*.ts` 或配置表。
- 内容：为五类流程定义节点链路；二审空窗逻辑；C&D 分支（非白名单且类型=关联，RSM 后插 C&D，上传凭证后继续）。
- 完成标准：创建流程时自动插入节点；查询返回节点列表与当前节点。

## 任务 5：主数据接入（依赖确认）
- 内容：接入医院/药店/代表/区域接口或文件；落库；权限过滤（提交人权限内机构、管理链路下属）。
- 完成标准：创建流程时校验权限范围；主数据/白名单优先，自由填兜底。
- 依赖：接口文档或文件字段、同步频率、鉴权方式。

## 任务 6：指标弱校验接入（依赖确认）
- 内容：获取权限内机构的可分配额度（医院）；弱校验=校验 100% 与权限，不锁额度；可记录提示。
- 完成标准：提交时执行弱校验；返回校验结果；并发不报错（仅提示）。
- 依赖：额度字段/单位、接口/文件方式、同步频率。

## 任务 7：白名单导入与生效（依赖确认）
- 内容：导入白名单（CSV/Excel），字段校验；覆盖策略；流程中变动自动驳回提示；已归档不受影响。
- 完成标准：导入日志、状态；流程创建/审批时白名单过滤生效；变动时自动提示/驳回。
- 依赖：白名单文件字段与格式、覆盖规则。

## 任务 8：流程动作处理
- 内容：实现 `POST /workflows/:id/actions`：权限校验→状态机→记录 workflow_actions→更新节点状态；支持通过/驳回/退回/撤回（撤回：申请人+BISO1+BISO2，配置化）。
- 完成标准：端到端测试覆盖五类流程（含分支、退回/撤回/驳回）。

## 任务 9：邮件内审批（企业微信 OAuth 短链）（依赖确认）
- 内容：短链生成与签名、有效期/单次使用校验、OAuth 跳转、回调执行通过/驳回（驳回需意见）。
- 完成标准：合法短链可审批；过期/重复/篡改拒绝；审计记录保留。
- 依赖：企业微信 CorpID/Secret、短链签名密钥、回调域/路径要求。

## 任务 10：导出与筛选
- 内容：`/workflows/export`（CSV/XLSX，全字段）、模板下载；筛选条件（流程、状态、角色/节点、时间、区域、机构/药店、跨区标记、C&D 标记）；权限过滤。
- 完成标准：字段完整、无乱码；筛选结果准确；权限过滤正确。
- 依赖：最终导出字段与合规要求。

## 任务 11：表单与校验细化
- 内容：五类表单校验（必填、格式、附件必填场景、100% 分配、岗位匹配、跨区=下属）；白名单优先，主数据搜索，兜底自由填标记 source。
- 完成标准：校验失败阻断；附件格式限制（jpg/png）；100% 分配校验生效；岗位匹配与跨区限制生效。
- 依赖：表单字段最终确认（若有调整）。

## 任务 12：测试与 CI 扩充
- 内容：新增 unit/integration/e2e 覆盖状态机、权限、节点分支、弱校验、白名单、邮件短链；在 CI 中执行；可选启用 contract-test。
- 完成标准：CI 全绿；关键路径有自动化测试。

## 任务 13：运维与同步文档
- 内容：编写数据同步说明（销售数据、白名单、指标）、接口对接说明、故障/降级策略、日志与审计要求。
- 完成标准：文档可供运维/数据同事执行与排障。

## 需业务/数据同事提供的确认项汇总
- 销售主数据/权限：接口或文件字段、唯一标识、同步频率、鉴权。
- 白名单：文件格式/字段、覆盖规则、生效与自动驳回策略。
- 指标：额度字段/单位、接口/文件、频率、并发限制。
- 企业微信：CorpID/Secret、短链签名密钥、回调域/路径要求。
- 导出：字段清单、合规/脱敏要求。
