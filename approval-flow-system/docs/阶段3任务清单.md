# 阶段 3 任务清单（基于当前进展）

## 目标
- 接入真实鉴权上下文、完善导出能力、补齐白名单/主数据导入记录、完善弱校验归档、短链审批占位、操作审计。

## 任务明细
1. 鉴权与上下文
   - 接入企业微信/OAuth/JWT 登录态，统一获取用户唯一标识（userId/邮箱/工号）。
   - 角色映射：岗位号 ↔ 角色（MR/DSM/RSM/BISO1/BISO2/RSD/CD），统一中间件自动注入 actorCode/actorRole。
   - 权限过滤：提交/审批/查看/导出使用统一鉴权，去除 header 占位。
   - 测试：越权访问 403，草稿仅本人可见，导出仅 BISO1/BISO2。

2. 主数据/白名单导入强化
   - 导入记录：医院/药店/代表/白名单导入批次与时间戳，导入日志表。
   - 白名单：保留覆盖策略，增加导入时间可追溯。
   - 文件容错：字段增减提示，缺关键字段时报错。
   - 测试：导入新批次，数据覆盖与回溯正常。

3. 指标分配弱校验归档
   - 取消关联医院分配记录随流程归档（payload 内可见）。
   - 校验合计=100%，审批链保持，不回写额度。
   - 测试：分配不足/超 100 报错，归档后可查看分配记录。

4. 导出与筛选完善
   - 导出格式：CSV/XLSX（已实现）。
   - 可选筛选参数（流程类型/状态/时间范围/角色）按需扩展（已支持类型/状态/时间）。
   - 审计导出操作（用户/时间/过滤条件）。
   - 测试：正确角色导出成功，越权导出 403。

5. 邮件/企业微信短链审批占位
   - 短链生成：签名、有效期、单次使用；包含流程 ID/动作/角色。（已加入签名与过期校验的占位服务）
   - 回调接口：校验签名/过期/单次使用，执行 approve/reject（驳回必填意见）。（已新增占位接口 `POST /workflows/shortlink/actions`，含防重放）
   - 日志：短链生成与使用记录。
   - 测试：签名错误/过期/重复使用报错；正常链路可审批。

6. 操作审计
   - 记录创建/提交/审批/导出/导入/短链使用（已写入 OperationLog）。
   - 提供查询接口（已完成）。
   - 测试：操作后日志可查询，字段完整。

7. 文档与测试
   - 更新执行记录，跟进任务完成情况。
   - 增补单元/集成测试（鉴权、导出、短链签名、分配校验）。
   - CI 保持全绿。

## 现状与已知依赖
- 鉴权：企业微信正式参数尚未接入，当前用 header 占位。
- 主数据：线下文件为主，格式固定；导入日志与错误明细已落地。
- 指标：无额度数据，不回写。
- 导出：仅 BISO1/BISO2，全字段，无脱敏；已支持 CSV/XLSX 与基本筛选。
- 审计：OperationLog/ImportLog 表与查询接口已完成。
- 节点审批人配置：ApproverConfig 表与 CRUD 已完成，可维护企业邮箱/岗位号。
- 前端：PC（apps/web-pc，AntD+Vite+React），移动 H5（apps/web-mobile，AntD Mobile+Vite+React）骨架已搭建，等待接入鉴权与接口。
- 用户映射：UserMapping 表与导入脚本（人员.csv）已完成，可通过 `npm run import:users` 导入邮箱→岗位号→角色。空邮箱自动禁用。`GET /auth/mock-login` 提供占位登录获取 actorCode/actorRole。

## 建议执行顺序
1) 正式鉴权接入（企业微信）与身份映射  
2) 权限过滤最终版（基于主数据/审批人配置）  
3) 短链正式化（身份绑定、策略配置）  
4) 主数据/白名单自动导入流水与告警  
5) 导出/导入审计对外化，前端管理界面（日志、告警、节点人员配置）  
6) 补充测试与文档
