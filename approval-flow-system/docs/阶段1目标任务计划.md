# 阶段 1 目标任务计划（环境与基础设施）

## 任务 0：初始化仓库结构
- 目标：创建 mono-repo 骨架，含后端、mock、prisma、CI、dotenv 模板。
- 操作：
  - 仓库名：approval-flow-system（如已有仓库则保持现有，创建以下子目录）
  - 目录结构：
    ```
    approval-flow-system/
      apps/
        api/          # NestJS 后端
        mock/         # 三方接口 mock 服务
      prisma/         # Prisma schema & migrations
      scripts/        # 本地脚本
      .github/workflows/
      .env.example
      docker-compose.yml
      README.md
      .gitignore
    ```
  - .gitignore：.env、node_modules、dist、coverage、.DS_Store、*.log（如用 turbo 再加 .turbo）
- 验收：目录一致；.gitignore 覆盖项完整；README 含一键启动与 .env 配置说明。

## 任务 1：后端 API 初始化（apps/api）
- 目标：NestJS + TS 基础脚手架与结构。
- 操作：
  - 初始化 Nest 项目；安装依赖：@nestjs/common @nestjs/core @nestjs/swagger @nestjs/config、class-validator class-transformer、prisma @prisma/client、jest @types/jest ts-jest、eslint @typescript-eslint/*。
  - 基础结构：
    ```
    apps/api/src/
      main.ts
      app.module.ts
      common/filters|interceptors|guards/
      modules/health/
        health.module.ts
        health.controller.ts
    ```
  - main.ts：全局 ValidationPipe、统一异常响应、Swagger 挂载 /api-docs。
  - package.json scripts（api 侧）：start, start:dev, build, lint, test。
  - 补充 eslint/tsconfig/jest.config（或等效）以避免 CI 报缺配置。
- 验收：npm run start:dev 可启动；/health 返回 {status:"ok"}；/api-docs 可访问。

## 任务 2：Mock 服务初始化（apps/mock）
- 目标：按契约提供主数据/指标/通知 mock。
- 操作：
  - Node+TS，Express 或 Nest（推荐 Nest）。
  - 结构：
    ```
    apps/mock/src/
      main.ts
      modules/masterdata|metric|notify/
    ```
  - 接口：
    - GET /masterdata/hospitals
    - GET /masterdata/pharmacies
    - GET /masterdata/representatives
    - GET /masterdata/regions
    - GET /metric/hospital-target
    - POST /notify/approval
  - 返回固定/随机 JSON；错误码格式 {code:40001,message:"invalid parameter"}。
- 验收：npm run start:dev 可跑；上述 URL 均返回数据且字段与契约一致。

## 任务 3：Prisma + PostgreSQL 配置
- 目标：数据库框架就绪（本阶段不建业务表）。
- 操作：
  - prisma/schema.prisma：
    ```
    generator client { provider = "prisma-client-js" }
    datasource db { provider = "postgresql"; url = env("DATABASE_URL") }
    ```
  - package.json scripts：prisma:generate, prisma:migrate。
  - .env.example 添加 DATABASE_URL=postgres://approval_user:example_password@db:5432/approval_db（host 对应 compose 服务名）。
- 验收：npx prisma generate 成功；docker-compose 启动时 Postgres 正常。

## 任务 4：.env 模板与密钥管理
- 目标：统一环境变量标准与忽略策略。
- 操作：
  - .env.example：
    ```
    NODE_ENV=development
    APP_PORT=3000
    DATABASE_URL=postgres://approval_user:example_password@db:5432/approval_db
    MASTERDATA_BASE_URL=http://mock:4001
    METRIC_BASE_URL=http://mock:4001
    NOTIFICATION_BASE_URL=http://mock:4001
    WECHAT_CORP_ID=
    WECHAT_CORP_SECRET=
    SHORTLINK_SIGN_KEY=
    ```
  - README 说明 cp .env.example .env。
- 验收：cp .env.example .env 后可一键启动。

## 任务 5：一键启动（含 mock + DB）
- 目标：单命令启动全部服务。
- 操作：
  - docker-compose.yml 含 db、api、mock；api depends_on db,mock；提供示例 Dockerfile（api/mock）。
  - README 命令：docker compose up --build；标注 /health、/api-docs、mock 基础 URL。
- 验收：命令运行后 API 可访问、mock 可访问、DB 正常。

## 任务 6：CI（lint/test/build）
- 目标：PR 自动跑 lint/test/build，api+mock 均覆盖。
- 操作：
  - .github/workflows/ci.yml：checkout、setup-node（固定 Node 版本，使用根锁文件）、install、lint、test、build。对 api/mock 分别执行。
  - 预留 contract test 步骤注释。
- 验收：任意分支 push 触发 CI；lint/test/build 全绿方可合并。

## 任务 7：接口契约文档
- 目标：契约与 mock 对齐。
- 操作：docs/contracts.md，包含字段、样例响应、错误码。
  - 主数据：/masterdata/hospitals|pharmacies|representatives|regions
  - 指标：/metric/hospital-target（含可分配额度字段）
  - 通知：/notify/approval（请求体字段）
- 验收：字段完整、可独立阅读；mock 与契约一致。

## 任务 8（加分）：契约测试
- 目标：CI 校验 mock 符合契约。
- 操作：scripts/contract-test.js（或 TS），逐条请求契约接口，校验字段存在与错误码格式。
- 验收：PR 自动执行，失败不允许合并。

## 附加要求与注意
- 版本锁：固定 Node 版本（如 20 LTS），提交 lockfile，CI 使用同版本。
- 配置文件：api/mock 都需 eslint、tsconfig、jest 配置，防止 CI 报缺。
- 健康检查：/health 路由在 README 标明，便于 compose 验证。
- 数据库：compose 建议预创建用户/库和持久化卷。
- 导出/模板：本阶段不实现业务导出，仅在 README 提及后续阶段。
