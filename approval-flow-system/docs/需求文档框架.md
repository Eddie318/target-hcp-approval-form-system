# 需求文档框架（审批流系统）

## 1. 背景与目标
- 目标：搭建 5 类审批流程（新增目标医院、取消目标医院、新增关联药房、取消 Link 药店、区域调整）的一体化审批能力，满足线上提报、审批、归档、通知。
- 范围：仅覆盖审批流与表单；审批完成后仅归档与查询/导出，不做主数据/指标的线上调整；不含报表/BI（如有需补充）。

## 2. 角色与权限
- 主要角色：MR、DSM、RSM、BISO 1（原 Pei Shan）、BISO 2（原 Vivi）、RSD（原 Liu Yanxia）、C&D（原 Joyce）。
- 发起人：MR/DSM/RSM（PDF 明确的流程）；区域调整流程发起人是 DSM/RSM。
- 审批链：按流程逐级递进；BISO 1、BISO 2、C&D、RSD 节点支持二审批人，只有一审批人为空时才流转至二审批人；不做替补/转派/加签。
- 数据可见性：白名单药店/医院可见性按提交人区域；权限与主数据/指标表挂钩。

## 3. 通知与操作方式
- 提交/审批通知：邮件/站内信/待办。
- 邮件内审批：优先支持邮件直接通过/驳回；驳回需填写意见。安全策略：企业微信 OAuth 免登短链（点击跳转授权，带回 token 后执行通过/驳回）；不启用无登录直批。
- 抄送规则：通过/驳回/撤回的抄送人定义。

## 4. 数据与主数据依赖
- 机构、药店主数据：mapping 规则；查不到时支持自由填写机构/药店名称；编码规则暂定，本方负责规则与唯一性校验（现阶段自由填写，不自动生成，后续可按规则自动生成）。
- 白名单：线下 Excel 维护，每半年更新（暂定）。
- 指标表：用于目标医院、关联医院/药店可见性与指标分配校验。
- 附件存储：图片凭证上传，无大小/水印限制（可选后续设定）；需考虑存储位置与安全。

## 5. 流程概要（按 PDF）
### 5.1 新增目标医院
- 表单：机构名称/地址（自由填且优先主数据）、指派代表姓名（选择）、指派代表岗位号（自带）、新开凭证上传、新增理由。
- 审批链：MR/DSM/RSM → DSM → RSM → BISO 1 → BISO 2 → C&D → RSD（PDF 顺序），考虑二审批人。
- 规则：流程发起人可为 MR/DSM/RSM，审批逐级递进；系统信息归档，后续调整由线下/他系统负责。
- 待确认：邮件内审批可用性。

### 5.2 取消目标医院
- 表单：机构名称（选择目标医院）、机构编码（自带）、取消原因、搬迁/闭店/装修凭证（图片，必填）、指标重新分配（选择医院+百分比，需合计 100%）。
- 审批链：MR/DSM/RSM → DSM → RSM → BISO 1 → BISO 2 → RSD。
- 规则：指标分配必须 100%，提交人权限区域内机构；发起人 MR/DSM/RSM；系统归档。分配校验建议：前端从指标系统获取“提交人权限内机构+可分配额度/余额”，提交时后端复核合计 100%、机构在权限内、额度不超限，失败即拒。
- 强/弱校验示例：
  - 强校验（含锁定）：提交时实时锁定或扣减额度，防止并发占用，额度不足则提交失败；“锁定”指在审批/回写前预占额度，其他人无法再分配该部分。
  - 弱校验：仅基于当前列表校验 100% 与权限，不锁定额度，可能出现并发占用风险。
- 已确认：采用弱校验（仅过滤+校验，不锁定额度）。（仅过滤+校验）。

### 5.3 新增关联药房关系
- 表单：药店名称（白名单选择，缺失则主数据搜索，搜不到可填写）、药店编码（主数据自带，不生成则自由填写）、药店类型（A 类/关联）、关联医院名称与编码、A 类凭证（缺省时 C&D 审批节点上传）。
- 审批链：MR/DSM/RSM → DSM → RSM → BISO 1 → BISO 2 → RSD。若药店不在白名单（选择“其他”）且机构类型为“关联”，则在 RSM 节点后插入 C&D 审批节点，C&D 审批员必须提交凭证后才能继续流转，之后继续 BISO 1 → BISO 2 → RSD。
- 规则：A 类需凭证；关联药房不需凭证（但若触发 C&D 分支则需 C&D 上传凭证）；C&D 节点需支持上传；白名单可见性仅提交人区域医院下药店；自动编码规则需明确。
- 待确认：未来自动编码方案（暂按自由填写）。

### 5.4 取消 Link 药店
- 表单：机构名称（已关联药店、目标医院下）、机构编码（自带）、取消原因、搬迁/闭店/装修凭证（图片，必填）。
- 审批链：MR/DSM/RSM → DSM → RSM → BISO 1 → BISO 2 → RSD。
- 规则：仅归档；白名单/指标关联校验。
- 待确认：取消后对指标/关系的影响及线下回写责任。

### 5.5 区域调整
- 表单：机构名称、机构编码、调整前代表/岗位（自带）、调整后代表/岗位（选择+自带）、调整原因。
- 审批链：DSM/RSM（提交）→ RSM → BISO 1 → BISO 2 → RSD。
- 规则：仅 DSM/RSM 可提交；可选调整后代表范围为该 DSM/RSM 下所有代表（权限范围内，可跨区但需为其下属）；需岗位强制匹配（代表→代表/同级）；系统仅归档不回写。
- 跨区限制：无额外限制（仅限提交人管理链路内下属）。

**跨区规则建议（默认可行方案）**
- 允许跨区，但目标代表必须是提交人当前管理链路下的下属（防止越权）。
- 需校验目标代表在新区域的主数据/权限一致性（岗位、区域编码），跨区后指标、医院分配由线下/他系统处理。
- 如目标代表与目标医院区域不匹配，提示风险并允许管理员配置禁止/放行（默认放行+提示）。

## 6. 流程通用需求
- 草稿：支持另存草稿/继续编辑；草稿有效期与可见性。
- 审批动作：通过/驳回/退回修改；评论、附件补传（C&D 节点明确）。
- 终端支持：移动端支持流程创建（MR、DSM、RSM）和查看（所有角色）；PC 端支持创建/审批/筛选审批记录与批量导出。
- 归档：审批完成后在线归档；移动端+PC 可查；PC 支持批量导出；不做系统调整/回写。
- 日志与稽核：表单变更记录、审批记录、附件审计、导出。
### 撤回 vs 驳回（说明与权限）
- 撤回：由申请人或授权节点终止流程，状态“已撤回”，可修改后重提重走全流程；记录保留。当前权限：申请人、BISO 1、BISO 2；可配置扩展。
- 驳回：由当前审批人拒绝，状态“已驳回”，申请人可修改后重提重走全流程；记录保留。

## 7. 校验与规则
- 主数据匹配：机构/药店名称查重；编码可自由填写但需唯一性校验（规则待定）。
- 指标分配：取消目标医院时百分比合计 100%，选择范围限提交人权限区域内机构。
- 附件：必填条件（A 类、搬迁/闭店/装修）；格式建议限制为图片 jpg/png；无病毒扫描/水印/脱敏需求；保留期限：长期。
- 白名单可见性：提交人区域作用域，未关联医院是否可选（待明确）；白名单更新以最新为准，流程中若变动自动驳回并提示发起人，不影响已归档记录。

## 8. 系统集成
- 主数据系统：医院/药店查询、创建/回写、编码生成。
- 指标系统：目标医院、指标分配读取与回写。
- 通知系统：邮件/IM/待办；邮件内审批能力。

## 9. 非功能需求
- 性能：提交流程与审批响应时限；附件上传大小/并发。
- 权限与安全：按角色/区域/医院/药店控制；附件安全扫描。
- 可用性：异常重试、超时与补提；移动端/桌面端适配。

## 10. 待确认问题清单
- 自动编码：未来的生成规则与唯一性校验方式（当前自由填写，后续可补充规则）。
- 取消目标医院分配：选择强校验（实时锁定额度）或弱校验（仅过滤+校验，不锁定）。

## 11. 状态与动作（建议）
- 状态：草稿、待审批（首节点前）、审批中（逐节点）、已驳回、已撤回、已通过/归档。
- 动作：提交（草稿→待审批）、审批通过/驳回、退回（到申请人）、撤回（可配置节点）、重新提交（驳回/退回后重走全流程）、归档导出（PC 批量）。

## 12. 导出与筛选（PC）
- 批量导出格式：CSV、XLSX。
- 导出字段建议：流程类型、单号、标题/机构名称、当前状态、发起人、发起时间、当前处理人/节点、区域、医院/药店名称与编码、调整后代表（如有）、指标分配明细（取消目标医院）、最近审批意见与时间。
- 筛选字段建议：流程类型、状态、发起人、当前处理人、角色/节点、时间范围（发起/完成）、区域、机构/药店名称，是否跨区（区域调整）、是否触发 C&D 分支（新增关联药房）。
- 模板下载：提供 CSV/XLSX 字段列头示例文件，便于比对与导出/导入一致性。
